<html lang="en">
	<head>

		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

		<script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>

		<!-- Latest compiled and minified JavaScript -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

		<!-- SheetJS for parsing xls file -->
		<script lang="javascript" src="js/xlsx.core.min.js"></script>
		<script>
			var auth2;
			var googleUser;
			var userNum;
			
			var params = {
				client_id: "877919083410-kmf5737t33qkkrlo33ljlnho5ovl7r76.apps.googleusercontent.com",
				scope: "profile https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/calendar",
				fetch_basic_profile: true,
				prompt: "none"
			};

			var desiredData = {
				'range': {s: {c:0, r:0}, e: {c:0, r:0 }},
				'previousCell':"",
				'isBoundarySet': false,

				'member':[],
				'memberRow': 0,
				'isMemberSet': false,
				'defaultMember': ['BS','IU','JO','JP','LY','MY','SQ','WI']
			};
			var worksheet;

			var timearr = [];

			function appStart(){
				console.log("appStart");
				
				if (window.File && window.FileReader && window.FileList && window.Blob) {
  					// Great success! All the File APIs are supported.
  					console.log('support fileAPI');
  					// Setup the dnd listeners.
					dropZone = document.getElementById('drop-zone');
					dropZone.addEventListener('dragover', handleDragOver, false);
		 			dropZone.addEventListener('drop', handleFileSelect, false);

				} else {
  					alert('The File APIs are not fully supported in this browser.');
				}

				var nowdate = new Date();
				// Default month is next month
				document.getElementById("month").selectedIndex = nowdate.getMonth() + 1;
				timearr.push( nowdate.getFullYear().toString() );

				gapi.load('auth2', function(){

					// Start Signing in procedure
					auth2 = gapi.auth2.init(params);
					
					auth2.isSignedIn.listen(signinChanged);
	  				auth2.currentUser.listen(userChanged);

					if (auth2.isSignedIn.get() == true){
						console.log("already sign in");
					}else{
						console.log("Not yet sign in");
						
						auth2.signIn().then(function() {
			    			
			    			googleUser = auth2.currentUser.get();
			    			console.log(googleUser);
							onSuccess(googleUser);
			  				}, onFailure 
		  				);	
		  			}
					attachSignin(document.getElementById('signinBtn'));
				});		
			}

			// Reaction when press sign in button
			function attachSignin(element) {
			    console.log(element.id);

			    /* Use prompt to let user choose whether to login another account
			    ** Should modify later
			    */
			    auth2.attachClickHandler(element, {
					client_id: "877919083410-kmf5737t33qkkrlo33ljlnho5ovl7r76.apps.googleusercontent.com",
					scope: "profile",
					fetch_basic_profile: true,
					prompt: "select_account consent"
				}, onSuccess, onFailure);
			}

			function userChanged(user){

				if (auth2.isSignedIn.get() == true){
					console.log("now user: " + user.getBasicProfile().getEmail());
					document.getElementById('name').innerText = user.getBasicProfile().getEmail();
				}
				googleUser = user;
			}

			function signinChanged(val){
				console.log("sign in state change to: " + val);
				if (!val){
					document.getElementById('signoutBtn').style.visibility = "hidden";
					document.getElementById('name').style.visibility = "hidden";
				}else{
					document.getElementById('signoutBtn').style.visibility = "visible";
					document.getElementById('name').style.visibility = "visible";
				}
			}

			function onSuccess(user){
				console.log("onSuccess");
				
				// Change userNum for usage in checkAuth
				userNum = parseInt(user.hg.session_state.extraQueryParams.authuser);
				console.log(userNum);
			}

			function onFailure(error){
				console.log("onFailure");
				alert(JSON.stringify( error,undefined,2) );
			}

			function signOut(){
				
				auth2 = gapi.auth2.getAuthInstance();
				auth2.disconnect();
				console.log("authorized scopes:" + auth2.currentUser.get().getGrantedScopes());
				auth2.signOut().then( function(){console.log("User signed out!")},
				function(){console.log("signed out error")} );
			}

			function authResultHandle(result){

				console.log("authResultHandle");
				console.log(result);
				if (!result){
					console.log("result empty");
				}
				if (result.error){
					console.log("result error");
				}

				if (!googleUser.hasGrantedScopes('email https://www.googleapis.com/auth/calendar')){
					console.log("User not grant calendar");
				}
				console.log(result.error);
				console.log(googleUser.hasGrantedScopes('email https://www.googleapis.com/auth/calendar'));
				if (!result || result.error || !googleUser.hasGrantedScopes('email https://www.googleapis.com/auth/calendar') ){
				// Fail case
					console.log("result false");
					
					var options = new gapi.auth2.SigninOptionsBuilder(
			        {'scope': 'email https://www.googleapis.com/auth/calendar',
			    	 'prompt': 'select_account consent',
			    	});

					//console.log(options);

					googleUser = auth2.currentUser.get();
					googleUser.grant(options).then(
			    	
			    	function(success){
			    		console.log("Success");
			     		console.log(JSON.stringify({message: "success", value: success}));
			    	},
			    	function(fail){
			    		console.log("fail");
			      		alert(JSON.stringify({message: "fail", value: fail}));
					});
				}else{
				// Successful log in. Start loading google calendar api
					console.log("result true");
					loadCalendarApi();
				}
			}

			function checkAuth() {
				console.log("checkAuth userNum: " + userNum);
				gapi.auth.authorize({
					client_id: "877919083410-kmf5737t33qkkrlo33ljlnho5ovl7r76.apps.googleusercontent.com",
					scope: "email https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/userinfo.email",
					immediate: false,
					authuser: userNum}, authResultHandle);
			}


			function loadCalendarApi(){
				console.log("loadCalendarApi");
				gapi.client.load('calendar', 'v3', getInsertData);
			}

			function formatDay(n){
    			return n > 9 ? "" + n: "0" + n;
			}

			function checkDate(arr){
				var m = parseInt(arr[1]);
				var d = parseInt(arr[2]);
				switch(m){
					case 1:
					case 3:
					case 5:
					case 7:
					case 8:
					case 10:
					case 12:
						if (arr[2] > 31){
							arr[1] = (m+1).toString();
							arr[2] = "1";
						}
						break;
					case 2:
						if (arr[2] > 28){
							arr[1] = (m+1).toString();
							arr[2] = "1";
						}
						break;
					case 4:
					case 6:
					case 9:
					case 11:
						if (arr[2] > 30){
								arr[1] = (m+1).toString();
								arr[2] = "1";
							}
						break;
				}
				console.log(arr);
				return arr;
			}

			function getInsertData(){

				console.log("getInsertData");
				var mth = document.getElementById("month");
				var mber = document.getElementById("member");
				
				var selectMonth = mth.options[mth.selectedIndex].value;
				var selectMember = mber.options[mber.selectedIndex].value;
				timearr.push(selectMonth);

				var day = 1;
				var eventarr=[];
				/*
				 * Extract data and form event object
				 */
				for(var R = desiredData.range.s.r; R <= desiredData.range.e.r; ++R) {
  					for(var C = desiredData.range.s.c; C <= desiredData.range.e.c; ++C) {

    					var cell_address = {c:C, r:R};
    					var encode_address = XLSX.utils.encode_cell(cell_address);
  						console.log("encode_address: " + encode_address);
  						if (typeof worksheet[encode_address] != "undefined"){
  							//("0" + daycount).slice(-2)
  							if (worksheet[encode_address].v === selectMember){
  								
  								// Use local object to avoid day incorrectness.
  								// Declare as global would cause this incorrectness.
  								var radioevent = {
									'summary': '',
									'start':{
										'dateTime': '',
										'timeZone': 'Asia/Taipei'
									},
									'end':{
										'dateTime': '',
										'timeZone': 'Asia/Taipei'
									}
								};
  								console.log("cell: " + encode_address);

  								timearr[2] = formatDay(day);
  								
  								switch(cell_address.c){
  									case 2:
  									case 3:
  									case 4:
  										radioevent.summary = 'QC';
  										radioevent.start.dateTime = timearr.join('-') + "T07:00:00";
  										radioevent.end.dateTime = timearr.join('-') + "T13:00:00";
  										break;
  									case 5:
  									case 6:
  									case 7:
  										radioevent.summary = "QC";
  										radioevent.start.dateTime = timearr.join('-') + "T13:00:00";
  										radioevent.end.dateTime = timearr.join('-') + "T19:00:00";
  										break;
  									case 8:
  										radioevent.summary = "QC_L";
  										radioevent.start.dateTime = timearr.join('-') + "T19:00:00";
  										
  										timearr[2] = formatDay(day+1);
  										console.log(timearr);
  										timearr = checkDate(timearr);
										console.log(timearr);
										radioevent.end.dateTime = timearr.join('-') + "T07:00:00";
  										break;

  									case 9:
  										radioevent.summary = "QC_G";
  										radioevent.start.dateTime = timearr.join('-') + "T19:00:00";
  										
  										timearr[2] = formatDay(day+1);
  										console.log(timearr);
  										timearr = checkDate(timearr);
  										console.log(timearr);
  										radioevent.end.dateTime = timearr.join('-') + "T07:00:00";
  										break;
  								}//End of switch
  								console.log(radioevent);

  								eventarr.push(radioevent);
  								
  							}// End ** if (worksheet[encode_address].v === selectMember)
  						}// End ** if (typeof worksheet[encode_address] != "undefined")
  					}
  					day++;
				}// End of for loop
				insertEvent(eventarr);
			}// End ** function insertEvent

			function insertEvent(eventlist){

				console.log(eventlist);
				console.log("insertEvent: " + eventlist.length);
				
				var i = 0;
				var nInterId;
				var insertResult;
				var resultarr = [];
				nInterId = setInterval(function(){

					if (i < eventlist.length){
						insertResult = insertRequest(eventlist[i],1000,3,i);
						console.log("insertResult: " + insertResult + ", type: " + typeof insertResult);
						resultarr[i] = insertResult; 
						i++;

						console.log(resultarr);
					}else{
						clearInterval(nInterId);
						console.log("clearInterval");
					}
				}, 3000);	
			}

			function insertRequest(singleEvent,delay,retry,eventnum){

				console.log(eventnum + " insertRequest");
				var resultStatus;
				var intervalId;

				var request = gapi.client.calendar.events.insert({
			  		'calendarId': 'primary',
			  		'resource': singleEvent
				});

				request.execute(function(result) {
					console.log(result);
					console.log(eventnum + " request result: " + result.status + ", type: " + typeof result.status);
					resultStatus = result.status;
				});

				intervalId = setInterval(function(){
					if (typeof resultStatus != "undefined"){
						clearInterval(intervalId);
						
						if (resultStatus != "confirmed"){
							
							if (retry > 0){
								delay *= 2;
								retry -= 1;
								console.log(eventnum + " delay: " +  delay + ", retry: " + retry);
								timeout = setTimeout(function(){
									insertRequest(singleEvent,delay,retry);
								},delay);
							}else{
								console.log(eventnum + " Retry used up. Give up on this event");
								return false;
							}

						}else{
							console.log(eventnum + " " + resultStatus);
							return true;
						}
					}else{
						console.log(eventnum + " Result status undefined. Not receive result yet.");
					}
				}, 1000);
			}

			function handleFileSelect(evt) {
				console.log('handleFileSelect');
				evt.stopPropagation();
				evt.preventDefault();

			    var files = evt.dataTransfer.files; // FileList object.
				
			    // files is a FileList of File objects. List some properties.
			    var output = [];
			    var i,f;
			    for (i = 0, f = files[i]; i != files.length; ++i) {
			      
			      	var reader = new FileReader();
			      	var name = f.name;
			      	// Show file names for user
			    	output.push('<strong>', escape(name), '</strong> ', ' - ', f.size, ' bytes');
			      
			      	reader.onload = function(e){
			      		var data = e.target.result;
			      		//console.log(data);
			      		var workbook = XLSX.read(data, {type: 'binary'});

			      		var firstsheet = workbook.SheetNames[0];
			      		worksheet = workbook.Sheets[firstsheet];
			      		//console.log(worksheet);
			      		for (z in worksheet){
			      			// Set boundary
			      			if(z[0] === '!') {
			      				continue;
			      			}else if(XLSX.utils.decode_cell(z).c == 0){
			      				console.log('first column');
			      				/* 
			      				 * Set up starting column, ending row and column
			      				 * Choose first row
			      				*/
			      				if(desiredData.previousCell.length != 0 && worksheet[desiredData.previousCell].v == '小夜' && worksheet[z].v == '1'){
			      					
			      					desiredData.range.e.c = XLSX.utils.decode_cell(desiredData.previousCell).c;
			      					desiredData.range.s.r = XLSX.utils.decode_cell(z).r;	
			      				}

			      				// For special character 連班上限......
			      				if(XLSX.utils.decode_cell(z).r > 20 && isNaN( parseInt(worksheet[z].v) ) && !desiredData.isBoundarySet ){
			      					console.log("first layer");
			      					if(XLSX.utils.decode_cell(z).r - desiredData.range.s.r < 32){
			      						console.log("second layer");
			      						desiredData.range.e.r = XLSX.utils.decode_cell(desiredData.previousCell).r;
			      						desiredData.isBoundarySet = true;

			      						console.log(desiredData.range);
			      					}
			      				}
			      				
			      				if (desiredData.previousCell.length != 0 && worksheet[desiredData.previousCell].v == '工級人員簽名'){
				      					desiredData.memberRow = XLSX.utils.decode_cell(z).r;
				      					console.log("member row: " + desiredData.memberRow);

				      			}

								if(XLSX.utils.decode_cell(z).r >= desiredData.memberRow && desiredData.memberRow > 0){
			      						
			      						if ( !worksheet[z].v.startsWith('製') ){
			      							console.log("add member:" + worksheet[z].v);
			      							desiredData.member.push(worksheet[z].v);
										}else{
											desiredData.memberSet = true;
											console.log("final");
										}
			      					}			      				

			      			}else if(worksheet[z].v == "早班"){
			      				// Set up starting row
			      				desiredData.range.s.c = XLSX.utils.decode_cell(z).c;
			      			}

			      			console.log(z + " = " + JSON.stringify(worksheet[z].v));
			      			desiredData.previousCell = z;
			      		};//End of for loop
			      		if (!desiredData.memberSet){
			      			desiredData.member = desiredData.defaultMember;
			      		}

			      		// If boundary still not set, use the last cell as lower boundary
			      		if (!desiredData.isBoundarySet ){
			      			desiredData.range.e.r = XLSX.utils.decode_cell(desiredData.previousCell).r;
			      			desiredData.isBoundarySet = true;

			      			console.log(desiredData.range);
			      		}
			      		showMemberSelect(desiredData.member);
			      	};// End of onload
			      	
			      	// Error handle
			      	reader.onerror = function(e){
        				console.log(e);
   					 };
			      	
			      	reader.readAsBinaryString(f);
			    }
			    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';   
			}

			function showMemberSelect(member){
				console.log(member);
				var select = document.getElementById("member");
				// Dynamically generate select options
				for (var i = 0; i < member.length ; i ++){
					select.options[select.options.length] = new Option(member[i], member[i]);
				}
				document.getElementById("member-container").style.display = "block";
				document.getElementById("insert").removeAttribute("disabled");
			}

			function handleDragOver(evt) {
				console.log('handleDragOver');
			    evt.stopPropagation();
			    evt.preventDefault();
			    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
			}

		</script>
		<script src="https://apis.google.com/js/client.js?onload=appStart"></script>

		<style type="text/css">
	    #signinBtn {
	      display: inline-block;
	      background: white;
	      color: #444;
	      width: 100px;
	      height: 30px;
	      border-radius: 5px;
	      border: thin solid #888;
	      box-shadow: 1px 1px 1px grey;
	      white-space: nowrap;
	    }

	    #signoutBtn{
	    	display: inline-block;
	    	background: white;
	    	color: #222;
	    	width: 100px;
	    	height:30px;
	    	border-radius: 5px;
	      	border: thin solid #888;
	      	box-shadow: 1px 1px 1px grey;
	      	white-space: nowrap;
	    }

	    #drop-zone{
	    	margin-left: 10%;
	    	margin-right: 10%;
	    	margin-top: 30px;
	    	margin-bottom: 30px;
	    	font-family: 'Helvetica Neue',Helvetica,Arial,sans-serif;
	    	font-size: 26px;
	    	color: #BBB;
	    	padding: 25px;
	    	width: 80%;
	    	height: 60%;
	    	border: 2px dashed #BBB;
	    	border-radius: 5px;
	    	text-align: center;
	    }
	    .selector-container{
	    	width: 65px;
	    	margin: 5px;
	    }

	    #header{
	    	height: 80px;
	    	background-color: #000;
	    }
	    #name{
	    	color: #FFF;
	    }

	    #button-zone{
	    	width:300px;
	    	position: absolute;
	    	right: 20px;
	    }
	    </style>
	</head>
	
	<body>

	
	<div class=container id="header">
		
		<div id='name'></div>
		
		<div id = "button-zone">
			<div id="signinBtn">
				<span class="buttonText">Google</span>
			</div>

			<div id="signoutBtn" onclick="signOut()">
				<span class="buttonText">Sign out</span>
			</div>
		</div>
	</div>

	<div id="drop-zone">Drop files here
		<output id="list"></output>
	</div>

	<label for="month">Select a month :</label>
	<div class="selector-container">
		<select class="form-control" id="month">
			<option value="01">Jan</option>
			<option value="02">Feb</option>
			<option value="03">Mar</option>
			<option value="04">Apr</option>
			<option value="05">May</option>
			<option value="06">Jun</option>
			<option value="07">Jul</option>
			<option value="08">Aug</option>
			<option value="09">Sep</option>
			<option value="10">Oct</option>
			<option value="11">Nov</option>
			<option value="12">Dec</option>
		</select>
	</div>

	<div id= "member-container" style="display:none">
		<label for="member">Select a member :</label>
		<div class="selector-container">
			<select class="form-control" id="member" required></select>
		</div>	
	</div>

	<button id="insert" onclick='checkAuth()' class="btn btn-primary" disabled>Insert</button>
	<script>
		
	</script>
	</body>
</html>